<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>VaultSheet Pro – Next-Gen Password Vault</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!--
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔐 VaultSheet Pro v1.1 - Enhanced Password Vault with Auto-Detection (FIXED)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

© 2025 VaultSheet Pro. All Rights Reserved.

FIXES v1.1.1:
- Fixed auto-detection infinite loading issue
- Improved startup sequence with proper error handling
- Added fallback mechanism for browser compatibility
- Enhanced user experience with clear status messages

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
-->
<style>:root{--purple-50:#faf5ff;--purple-100:#f3e8ff;--purple-200:#e9d5ff;--purple-300:#d8b4fe;--purple-400:#c084fc;--purple-500:#a855f7;--purple-600:#9333ea;--purple-700:#7c3aed;--purple-800:#6b21a8;--purple-900:#581c87;--purple-950:#3b0764;--indigo-600:#4f46e5;--indigo-700:#4338ca;--indigo-800:#3730a3;--pink-500:#ec4899;--pink-600:#db2777;--fuchsia-500:#d946ef;--violet-500:#8b5cf6;--violet-600:#7c3aed;--gradient-primary:linear-gradient(135deg,var(--purple-600),var(--indigo-700));--gradient-secondary:linear-gradient(135deg,var(--purple-500),var(--pink-600));--gradient-accent:linear-gradient(135deg,var(--fuchsia-500),var(--purple-600));--gradient-dark:linear-gradient(135deg,var(--purple-800),var(--purple-950));--gradient-light:linear-gradient(135deg,var(--purple-50),var(--purple-100));--gradient-glass:linear-gradient(135deg,rgba(255,255,255,.1),rgba(255,255,255,.05));--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;--gray-800:#1f2937;--gray-900:#111827;--success:#10b981;--danger:#ef4444;--warning:#f59e0b;--info:#3b82f6;--radius:16px;--radius-sm:8px;--radius-lg:24px;--radius-xl:32px;--shadow-sm:0 1px 2px 0 rgba(0,0,0,.05);--shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);--shadow-md:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);--shadow-lg:0 20px 25px -5px rgba(139,92,246,.1),0 10px 10px -5px rgba(139,92,246,.04);--shadow-purple:0 25px 50px -12px rgba(139,92,246,.25);--glow-purple:0 0 30px rgba(168,85,247,.3);--glow-accent:0 0 20px rgba(217,70,239,.4);--transition-fast:0.15s cubic-bezier(0.4,0,0.2,1);--transition-smooth:0.3s cubic-bezier(0.4,0,0.2,1);--transition-slow:0.5s cubic-bezier(0.4,0,0.2,1)}*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,sans-serif;background:var(--gradient-primary);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow-x:hidden}body::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(circle at 20% 30%,rgba(168,85,247,.4) 0%,transparent 40%),radial-gradient(circle at 80% 70%,rgba(236,72,153,.3) 0%,transparent 50%),radial-gradient(circle at 50% 50%,rgba(217,70,239,.2) 0%,transparent 60%);animation:float 25s ease-in-out infinite;z-index:0}@keyframes float{0%,100%{transform:translateY(0px) rotate(0deg) scale(1)}33%{transform:translateY(-15px) rotate(1deg) scale(1.05)}66%{transform:translateY(10px) rotate(-0.5deg) scale(0.98)}}body::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background-image:radial-gradient(2px 2px at 20px 30px,rgba(255,255,255,.3),transparent),radial-gradient(2px 2px at 40px 70px,rgba(168,85,247,.4),transparent),radial-gradient(1px 1px at 90px 40px,rgba(236,72,153,.3),transparent);background-repeat:repeat;background-size:100px 100px;animation:sparkle 20s linear infinite;z-index:0;opacity:.6}@keyframes sparkle{0%{transform:translateY(0px)}100%{transform:translateY(-100px)}}.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);z-index:2000;display:none;align-items:center;justify-content:center;animation:fadeIn .3s ease}.loading-spinner{display:flex;flex-direction:column;align-items:center;gap:20px;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);padding:40px;border-radius:var(--radius-lg);box-shadow:var(--shadow-purple);border:1px solid rgba(168,85,247,.3)}.spinner{width:50px;height:50px;border:4px solid rgba(168,85,247,.2);border-top:4px solid var(--purple-600);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.loading-text{font-size:1rem;font-weight:600;color:var(--purple-800);text-align:center;line-height:1.5}.loading-progress{width:200px;height:4px;background:rgba(168,85,247,.2);border-radius:2px;overflow:hidden}.loading-progress-bar{height:100%;background:var(--gradient-primary);border-radius:2px;width:0%;animation:progress 2s ease-in-out infinite}@keyframes progress{0%{width:0%;transform:translateX(-100%)}50%{width:100%;transform:translateX(0%)}100%{width:100%;transform:translateX(100%)}}.btn-loading{position:relative;pointer-events:none}.btn-loading .btn-text{opacity:0}.btn-loading::after{content:'';position:absolute;top:50%;left:50%;margin:-10px 0 0 -10px;width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top:2px solid #fff;border-radius:50%;animation:spin .8s linear infinite}.status-pulse{animation:pulse-glow 2s ease-in-out infinite}@keyframes pulse-glow{0%,100%{box-shadow:0 0 5px rgba(168,85,247,.3)}50%{box-shadow:0 0 20px rgba(168,85,247,.6),0 0 30px rgba(168,85,247,.4)}}.success-checkmark{width:50px;height:50px;border-radius:50%;background:var(--success);display:flex;align-items:center;justify-content:center;animation:bounceIn .6s ease}@keyframes bounceIn{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}.startup-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border-radius:var(--radius-lg);padding:30px 40px;box-shadow:var(--shadow-purple);border:1px solid rgba(168,85,247,.3);z-index:1500;display:none;text-align:center;min-width:400px}.startup-title{font-size:1.2rem;font-weight:700;color:var(--purple-800);margin-bottom:12px;display:flex;align-items:center;justify-content:center;gap:10px}.startup-text{color:var(--gray-700);line-height:1.5;margin-bottom:20px}.startup-btn{background:var(--gradient-primary);color:#fff;border:none;padding:12px 24px;border-radius:var(--radius-sm);font-weight:600;cursor:pointer;transition:all var(--transition-smooth)}.startup-btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(147,51,234,.4)}.auto-connect-message{background:linear-gradient(135deg,rgba(16,185,129,.1),rgba(5,150,105,.05));color:var(--success);padding:15px;border-radius:var(--radius-sm);margin-bottom:20px;border:1px solid rgba(16,185,129,.2);display:flex;align-items:center;gap:10px}.app{width:100%;max-width:1540px;background:rgba(255,255,255,.95);backdrop-filter:blur(25px);border-radius:var(--radius-xl);box-shadow:var(--shadow-purple);border:1px solid rgba(255,255,255,.3);overflow:hidden;display:flex;flex-direction:column;height:92vh;position:relative;z-index:1;transition:all var(--transition-smooth)}.app:hover{box-shadow:0 30px 60px -15px rgba(139,92,246,.3)}.header{background:var(--gradient-dark);color:#fff;position:relative;overflow:hidden}.header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent);animation:shimmer 4s linear infinite}@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}.header-content{display:flex;align-items:stretch;position:relative;z-index:2}.header-left{display:flex;align-items:center;gap:16px;padding:24px 28px;flex:1}.header-icon{font-size:2.5rem;background:var(--gradient-accent);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 10px rgba(139,92,246,.5));animation:pulse 3s ease-in-out infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.header-title{font-size:1.8rem;font-weight:800;letter-spacing:-0.025em;background:linear-gradient(135deg,#fff,var(--purple-200));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.tabs{display:flex;background:rgba(0,0,0,.3);backdrop-filter:blur(15px)}.tab{padding:18px 28px;cursor:pointer;color:rgba(255,255,255,.7);font-weight:600;font-size:.95rem;border-bottom:3px solid transparent;transition:all var(--transition-smooth);display:flex;align-items:center;gap:10px;position:relative;overflow:hidden}.tab::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:var(--gradient-glass);opacity:0;transition:opacity var(--transition-smooth)}.tab:hover{color:#fff;transform:translateY(-2px)}.tab:hover::before{opacity:1}.tab.active{color:#fff;border-bottom-color:var(--fuchsia-500);background:linear-gradient(135deg,rgba(168,85,247,.4),rgba(236,72,153,.3));box-shadow:inset 0 2px 0 rgba(255,255,255,.2),var(--glow-accent)}.header-search{padding:18px 28px;display:flex;align-items:center}.search-wrapper{position:relative}.search-input{padding:12px 16px 12px 44px;border:none;border-radius:var(--radius);background:rgba(255,255,255,.15);backdrop-filter:blur(10px);color:#fff;font-size:.95rem;outline:none;width:300px;border:1px solid rgba(255,255,255,.2);transition:all var(--transition-smooth)}.search-input::placeholder{color:rgba(255,255,255,.6)}.search-input:focus{background:rgba(255,255,255,.25);box-shadow:var(--glow-purple);border-color:var(--purple-400);transform:scale(1.02)}.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.6);transition:color var(--transition-fast)}.search-wrapper:focus-within .search-icon{color:var(--purple-300)}.content{display:flex;flex:1;min-height:0}.sidebar{flex:0 0 380px;background:var(--gradient-light);border-right:1px solid rgba(139,92,246,.1);padding:32px 28px;overflow-y:auto;position:relative}.sidebar::before{content:'';position:absolute;top:0;right:0;bottom:0;width:1px;background:linear-gradient(to bottom,transparent,var(--purple-300),transparent)}.status-card{background:var(--gradient-glass);backdrop-filter:blur(20px);border:1px solid rgba(168,85,247,.2);border-radius:var(--radius);padding:20px;margin-bottom:24px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden;transition:all var(--transition-smooth)}.status-card::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(45deg,rgba(168,85,247,.05),transparent);transition:opacity var(--transition-smooth);opacity:0}.status-card:hover::before{opacity:1}.status-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}.status-text{font-size:.9rem;color:var(--purple-800);font-weight:500;line-height:1.5;position:relative;z-index:1}.form-group{margin-bottom:24px;position:relative}.form-label{display:block;font-weight:700;margin-bottom:8px;color:var(--purple-800);font-size:.9rem;letter-spacing:0.025em;transition:color var(--transition-fast)}.form-control{width:100%;padding:14px 16px;border:2px solid rgba(168,85,247,.2);border-radius:var(--radius-sm);background:rgba(255,255,255,.9);font-size:.95rem;color:var(--gray-800);transition:all var(--transition-smooth);backdrop-filter:blur(10px);position:relative}.form-control:focus{outline:none;border-color:var(--purple-500);background:rgba(255,255,255,.95);box-shadow:0 0 0 4px rgba(168,85,247,.1),var(--glow-purple);transform:translateY(-1px)}.form-control:focus + .form-label{color:var(--purple-600)}.form-control.textarea{resize:vertical;min-height:80px;font-family:inherit}.password-field{position:relative}.password-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);cursor:pointer;color:var(--purple-600);padding:6px;border-radius:6px;transition:all var(--transition-fast)}.password-toggle:hover{background:var(--purple-100);color:var(--purple-700);transform:translateY(-50%) scale(1.1)}.btn-group{display:flex;gap:12px;margin-top:28px;flex-wrap:wrap}.btn{padding:14px 24px;border:none;border-radius:var(--radius-sm);font-weight:700;font-size:.9rem;cursor:pointer;letter-spacing:0.025em;display:flex;align-items:center;gap:8px;transition:all var(--transition-smooth);position:relative;overflow:hidden}.btn::before{content:'';position:absolute;top:0;left:-100%;right:100%;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:all var(--transition-slow)}.btn:hover::before{left:100%;right:-100%}.btn:active{transform:scale(.98)}.btn-primary{background:var(--gradient-primary);color:#fff;box-shadow:0 4px 14px 0 rgba(147,51,234,.3)}.btn-primary:hover{transform:translateY(-3px);box-shadow:0 8px 25px 0 rgba(147,51,234,.4)}.btn-secondary{background:var(--gradient-glass);backdrop-filter:blur(10px);color:var(--gray-700);border:1px solid rgba(168,85,247,.2);box-shadow:0 4px 14px 0 rgba(107,114,128,.1)}.btn-secondary:hover{background:var(--gradient-dark);color:#fff;transform:translateY(-3px);border-color:transparent}.btn-success{background:linear-gradient(135deg,var(--success),#059669);color:#fff;box-shadow:0 4px 14px 0 rgba(16,185,129,.3)}.btn-success:hover{transform:translateY(-3px);box-shadow:0 8px 25px 0 rgba(16,185,129,.4)}.main-content{flex:1;padding:24px 28px;overflow:hidden;display:flex;flex-direction:column}.table-container{flex:1;background:rgba(255,255,255,.95);backdrop-filter:blur(20px);border:1px solid rgba(168,85,247,.1);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-lg);display:flex;flex-direction:column}.table-wrapper{flex:1;overflow:auto;scrollbar-width:thin;scrollbar-color:var(--purple-300) var(--purple-50)}.table-wrapper::-webkit-scrollbar{width:8px;height:8px}.table-wrapper::-webkit-scrollbar-track{background:var(--purple-50)}.table-wrapper::-webkit-scrollbar-thumb{background:var(--purple-300);border-radius:4px}.table-wrapper::-webkit-scrollbar-thumb:hover{background:var(--purple-500)}table{width:100%;border-collapse:collapse;table-layout:auto;min-width:1200px;contain:layout style paint;will-change:scroll-position}thead th{position:sticky;top:0;background:var(--gradient-dark);color:#fff;font-weight:700;font-size:.85rem;padding:16px 12px;text-align:left;letter-spacing:0.05em;text-transform:uppercase;border-bottom:2px solid var(--purple-600);box-shadow:0 2px 4px rgba(0,0,0,.1);white-space:nowrap;contain:layout style}.col-id{min-width:60px;width:4%}.col-user{min-width:140px;width:14%}.col-pass{min-width:200px;width:18%}.col-domain{min-width:160px;width:16%}.col-comments{min-width:180px;width:18%}.col-category{min-width:110px;width:10%}.col-created,.col-updated{min-width:130px;width:12%}.col-actions{min-width:140px;width:14%}tbody td{padding:14px 12px;border-bottom:1px solid rgba(168,85,247,.08);font-size:.9rem;vertical-align:middle;background:rgba(255,255,255,.7);transition:all var(--transition-fast);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;contain:layout style}tbody tr{transition:all var(--transition-smooth);transform:translateZ(0)}tbody tr:hover{background:linear-gradient(135deg,rgba(168,85,247,.08),rgba(236,72,153,.04));transform:translateY(-1px) translateZ(0);box-shadow:0 4px 12px rgba(168,85,247,.1)}tbody tr:last-child td{border-bottom:none}.password-actions,.table-actions{display:flex;align-items:center;gap:6px;flex-wrap:nowrap;justify-content:flex-start}.table-btn{background:rgba(255,255,255,.9);backdrop-filter:blur(8px);border:1px solid rgba(168,85,247,.15);cursor:pointer;padding:6px;border-radius:6px;color:var(--purple-600);transition:all var(--transition-smooth);display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;will-change:transform,background-color}.table-btn:hover{background:var(--purple-100);transform:scale(1.1) translateZ(0);box-shadow:0 2px 8px rgba(168,85,247,.2)}.table-btn.danger{color:var(--danger);border-color:rgba(239,68,68,.2)}.table-btn.danger:hover{background:rgba(239,68,68,.1);color:#dc2626}.table-btn.success{color:var(--success);border-color:rgba(16,185,129,.2)}.table-btn.success:hover{background:rgba(16,185,129,.1);color:#059669}.table-btn .material-icons{font-size:16px}.timestamp{font-size:.75rem;color:var(--gray-600);font-weight:600;padding:3px 8px;background:var(--gradient-glass);border-radius:12px;display:inline-block;backdrop-filter:blur(8px);border:1px solid rgba(168,85,247,.1);max-width:120px;overflow:hidden;text-overflow:ellipsis}.category-badge{background:var(--gradient-secondary);color:#fff;padding:4px 10px;border-radius:14px;font-size:.75rem;font-weight:700;letter-spacing:0.025em;box-shadow:var(--shadow-sm);text-transform:capitalize;transition:all var(--transition-fast);max-width:100px;overflow:hidden;text-overflow:ellipsis;display:inline-block}.category-badge:hover{transform:scale(1.05) translateZ(0);box-shadow:var(--shadow-md)}.pagination-container{padding:16px 28px;border-top:1px solid rgba(168,85,247,.1);background:var(--gradient-light);backdrop-filter:blur(15px);display:flex;justify-content:space-between;align-items:center}.pagination-info{font-size:.9rem;color:var(--purple-800);font-weight:600;padding:8px 16px;background:rgba(255,255,255,.7);border-radius:20px;backdrop-filter:blur(10px)}.pagination{display:flex;gap:6px;align-items:center}.pagination button{padding:8px 12px;border:none;border-radius:6px;background:rgba(255,255,255,.8);backdrop-filter:blur(10px);color:var(--purple-700);cursor:pointer;font-weight:600;transition:all var(--transition-smooth);border:1px solid rgba(168,85,247,.2);min-width:36px;height:36px;display:flex;align-items:center;justify-content:center}.pagination button:hover{background:var(--purple-100);transform:translateY(-1px) translateZ(0);box-shadow:0 4px 12px rgba(168,85,247,.2)}.pagination button.active{background:var(--gradient-primary);color:#fff;box-shadow:0 4px 14px rgba(147,51,234,.3)}.pagination button:disabled{opacity:.5;cursor:not-allowed;transform:none}.nav-btn{background:var(--gradient-primary);color:#fff}.nav-btn:hover{background:var(--gradient-dark)}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);backdrop-filter:blur(12px);z-index:1000;display:none;align-items:center;justify-content:center;animation:fadeIn var(--transition-smooth) ease}@keyframes fadeIn{from{opacity:0}to{opacity:1}}.modal{background:rgba(255,255,255,.95);backdrop-filter:blur(25px);border-radius:var(--radius-lg);box-shadow:var(--shadow-purple);width:90%;max-width:600px;max-height:85vh;overflow:hidden;border:1px solid rgba(168,85,247,.3);animation:modalSlide .5s cubic-bezier(.4,0,.2,1)}@keyframes modalSlide{from{opacity:0;transform:translateY(50px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}.modal-header{background:var(--gradient-dark);color:#fff;padding:24px 28px;display:flex;justify-content:space-between;align-items:center;position:relative}.modal-header::before{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--fuchsia-500),transparent)}.modal-title{font-size:1.3rem;font-weight:800;letter-spacing:-0.025em}.modal-close{background:rgba(255,255,255,.2);border:none;color:#fff;cursor:pointer;padding:8px;border-radius:8px;transition:all var(--transition-smooth)}.modal-close:hover{background:rgba(255,255,255,.3);transform:rotate(90deg) scale(1.1)}.modal-body{padding:28px;max-height:400px;overflow-y:auto}.add-category{display:flex;gap:12px;margin-bottom:24px}.add-category input{flex:1;padding:12px 16px;border:2px solid rgba(168,85,247,.2);border-radius:var(--radius-sm);background:rgba(255,255,255,.9);transition:all var(--transition-smooth)}.add-category input:focus{border-color:var(--purple-500);box-shadow:0 0 0 4px rgba(168,85,247,.1)}.category-item{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:var(--gradient-light);border:1px solid rgba(168,85,247,.15);border-radius:var(--radius-sm);margin-bottom:12px;transition:all var(--transition-smooth);box-shadow:var(--shadow-sm)}.category-item:hover{transform:translateY(-2px) translateZ(0);box-shadow:0 8px 25px rgba(168,85,247,.15)}.category-name{font-weight:700;color:var(--purple-800);font-size:.95rem}#toastContainer{position:fixed;top:24px;right:24px;z-index:1100;display:flex;flex-direction:column;gap:12px}.toast{padding:16px 20px;border-radius:var(--radius);color:#fff;font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:12px;min-width:280px;max-width:400px;backdrop-filter:blur(15px);box-shadow:0 20px 25px -5px rgba(0,0,0,.2),0 10px 10px -5px rgba(0,0,0,.04);animation:toastSlide .4s cubic-bezier(.4,0,.2,1),toastFade 4.5s ease forwards;border:1px solid rgba(255,255,255,.3)}@keyframes toastSlide{from{opacity:0;transform:translateX(100%) scale(.9)}to{opacity:1;transform:translateX(0) scale(1)}}@keyframes toastFade{0%,80%{opacity:1}100%{opacity:0}}.toast.success{background:linear-gradient(135deg,var(--success),#059669)}.toast.error{background:linear-gradient(135deg,var(--danger),#dc2626)}.toast.info{background:var(--gradient-primary)}.performance-indicator{position:fixed;bottom:20px;left:20px;background:rgba(0,0,0,.8);color:#fff;padding:8px 12px;border-radius:20px;font-size:.8rem;z-index:1100;backdrop-filter:blur(10px);display:none}@media(max-width:1200px){.app{max-width:95vw}.sidebar{flex:0 0 340px}table{min-width:1100px}}@media(max-width:1024px){.content{flex-direction:column}.sidebar{flex:none;border-right:none;border-bottom:1px solid rgba(168,85,247,.1)}.search-input{width:220px}table{min-width:1000px}}@media(max-width:768px){.header-content{flex-direction:column}.header-search{padding:16px 28px}.search-input{width:100%}.btn-group{flex-direction:column}.btn{justify-content:center}.sidebar{flex:0 0 auto}.pagination-container{flex-direction:column;gap:16px}table{min-width:900px}.table-btn{min-width:24px;height:24px;padding:4px}.table-btn .material-icons{font-size:14px}}@media(max-width:480px){.app{margin:10px;height:95vh;border-radius:var(--radius)}.sidebar{padding:20px}.main-content{padding:20px}table{min-width:800px}}@media (prefers-color-scheme: dark){.app{background:rgba(26,26,31,.95)}.sidebar{background:linear-gradient(135deg,rgba(26,26,31,.9),rgba(31,31,36,.9))}.form-control{background:rgba(31,31,36,.9);color:#fff}.status-text{color:var(--purple-300)}.form-label{color:var(--purple-300)}}</style>
</head>
<body>
<div class="app">
<div class="header">
<div class="header-content">
<div class="header-left">
<span class="material-icons header-icon">shield</span>
<h1 class="header-title">VaultSheet Pro</h1>
</div>
<div class="tabs">
<div class="tab active" data-tab="vault">
<span class="material-icons">lock</span>Secure Vault
</div>
<div class="tab" data-tab="categories">
<span class="material-icons">tune</span>Categories
</div>
</div>
<div class="header-search">
<div class="search-wrapper">
<span class="material-icons search-icon">search</span>
<input id="search" type="search" class="search-input" placeholder="Search your vault..." autocomplete="off">
</div>
</div>
</div>
</div>
<div class="content">
<div class="sidebar">
<div class="status-card">
<div class="status-text" id="status">Ready to secure your digital vault. Click "Select Vault Folder" to begin.</div>
</div>
<button class="btn btn-primary" id="pickFolder">
<span class="material-icons">folder_special</span>
<span class="btn-text">Select Vault Folder</span>
</button>
<div class="form-group">
<label class="form-label">Username</label>
<input id="username" class="form-control" autocomplete="off" placeholder="Enter username" spellcheck="false">
</div>
<div class="form-group">
<label class="form-label">Password</label>
<div class="password-field">
<input id="password" type="password" class="form-control" placeholder="Enter password" autocomplete="new-password">
<span id="togglePassword" class="material-icons password-toggle">visibility</span>
</div>
</div>
<div class="form-group">
<label class="form-label">Domain/Website</label>
<input id="domain" class="form-control" placeholder="example.com" spellcheck="false">
</div>
<div class="form-group">
<label class="form-label">Comments</label>
<textarea id="comments" class="form-control textarea" placeholder="Additional notes..."></textarea>
</div>
<div class="form-group">
<label class="form-label">Category</label>
<select id="categorySelect" class="form-control">
<option value="">Choose category...</option>
</select>
</div>
<div class="btn-group">
<button id="saveBtn" class="btn btn-primary">
<span class="material-icons">save_alt</span>
<span id="saveText" class="btn-text">Save Entry</span>
</button>
<button id="clearBtn" class="btn btn-secondary">
<span class="material-icons">refresh</span>
<span class="btn-text">Reset</span>
</button>
<button id="downloadBtn" class="btn btn-success">
<span class="material-icons">cloud_download</span>
<span class="btn-text">Export</span>
</button>
</div>
</div>
<div class="main-content">
<div class="table-container">
<div class="table-wrapper">
<table>
<thead>
<tr>
<th class="col-id">ID</th>
<th class="col-user">Username</th>
<th class="col-pass">Password</th>
<th class="col-domain">Domain</th>
<th class="col-comments">Comments</th>
<th class="col-category">Category</th>
<th class="col-created">Created</th>
<th class="col-updated">Updated</th>
<th class="col-actions">Actions</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
</div>
<div class="pagination-container">
<div class="pagination-info" id="paginationInfo">
Ready to manage your secure vault
</div>
<div class="pagination" id="pagination">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="modal-overlay" id="categoryModal">
<div class="modal">
<div class="modal-header">
<h3 class="modal-title">Category Management</h3>
<button class="modal-close" onclick="closeCategoryModal()">
<span class="material-icons">close</span>
</button>
</div>
<div class="modal-body">
<div class="add-category">
<input id="newCategoryInput" placeholder="New category name..." autocomplete="off" spellcheck="false">
<button class="btn btn-primary" onclick="addCategory()">
<span class="material-icons">add_circle</span>
<span class="btn-text">Add</span>
</button>
</div>
<div id="categoryList"></div>
</div>
</div>
</div>

<div class="startup-message" id="startupMessage">
<div class="startup-title">
<span class="material-icons">auto_awesome</span>
Smart Vault Detection
</div>
<div class="startup-text" id="startupText">
VaultSheet Pro is checking for existing data.xlsx files to automatically connect your vault...
</div>
<button class="startup-btn" id="startupBtn" onclick="handleStartupAction()">
<span class="material-icons">folder_open</span>
Select Folder
</button>
</div>

<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner">
<div class="spinner"></div>
<div class="loading-text" id="loadingText">Processing...</div>
<div class="loading-progress">
<div class="loading-progress-bar"></div>
</div>
</div>
</div>
<div id="toastContainer"></div>
<div class="performance-indicator" id="perfIndicator">⚡ Optimized</div>

<script>
/*
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔐 VaultSheet Pro v1.1.1 - FIXED Auto-Detection System
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

FIXES:
- Resolved infinite loading on startup
- Fixed auto-detection system
- Improved error handling and fallbacks
- Enhanced user experience with clear messaging

© 2025 VaultSheet Pro. All Rights Reserved.
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
*/

// 🛡️ ANTI-DEBUGGING & ACCESS PREVENTION
(function(){
    'use strict';
    
    document.addEventListener('contextmenu', e => {
        e.preventDefault();
        e.stopPropagation();
        showToast('🚫 Access Denied: Right-click disabled for security', 'error');
        return false;
    }, true);
    
    document.addEventListener('keydown', e => {
        if (e.keyCode === 123 || 
            (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) ||
            (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 80)) ||
            (e.ctrlKey && e.shiftKey && e.keyCode === 67)) {
            e.preventDefault();
            e.stopPropagation();
            showToast('🚫 Access Denied: Developer tools are disabled for security', 'error');
            return false;
        }
    }, true);
    
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('dragstart', e => e.preventDefault());
    
    console.log('%c🔐 SECURITY WARNING', 'color: red; font-size: 20px; font-weight: bold;');
    console.log('%cThis is a protected application. Unauthorized access is prohibited.', 'color: red; font-size: 14px;');
    console.log('%c© 2025 VaultSheet Pro v1.1.1. All Rights Reserved.', 'color: purple; font-size: 12px;');
    
})();

// 🔒 CORE APPLICATION CLASSES
class LoadingController {
    static show(message = 'Processing...', type = 'default') {
        const overlay = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        const spinner = overlay.querySelector('.loading-spinner');
        
        text.textContent = message;
        overlay.style.display = 'flex';
        
        if (type === 'success') {
            setTimeout(() => {
                spinner.innerHTML = '<div class="success-checkmark"><span class="material-icons">check</span></div>';
            }, 1000);
        }
        
        return overlay;
    }
    
    static hide(delay = 0) {
        setTimeout(() => {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';
            const spinner = overlay.querySelector('.loading-spinner');
            if (spinner.querySelector('.success-checkmark')) {
                spinner.innerHTML = '<div class="spinner"></div><div class="loading-text" id="loadingText">Processing...</div><div class="loading-progress"><div class="loading-progress-bar"></div></div>';
            }
        }, delay);
    }
    
    static updateText(message) {
        document.getElementById('loadingText').textContent = message;
    }
}

class StartupController {
    static show(title, message, buttonText = 'Select Folder', buttonAction = 'select') {
        const modal = document.getElementById('startupMessage');
        const titleEl = modal.querySelector('.startup-title');
        const textEl = modal.querySelector('.startup-text');
        const btnEl = modal.querySelector('.startup-btn');
        
        titleEl.innerHTML = `<span class="material-icons">auto_awesome</span>${title}`;
        textEl.textContent = message;
        btnEl.innerHTML = `<span class="material-icons">${buttonAction === 'select' ? 'folder_open' : 'check'}</span>${buttonText}`;
        btnEl.dataset.action = buttonAction;
        
        modal.style.display = 'block';
        return modal;
    }
    
    static hide(delay = 0) {
        setTimeout(() => {
            document.getElementById('startupMessage').style.display = 'none';
        }, delay);
    }
    
    static showAutoConnectSuccess(folderName, entryCount) {
        const modal = document.getElementById('startupMessage');
        const content = `
            <div class="auto-connect-message">
                <span class="material-icons">check_circle</span>
                <div>
                    <strong>Auto-connected to existing vault!</strong><br>
                    Found ${entryCount} entries in "${folderName}"
                </div>
            </div>
            <div class="startup-text">
                Your vault is ready to use. You can start managing your passwords immediately.
            </div>
        `;
        
        this.show('Vault Connected Successfully', '', 'Continue', 'continue');
        modal.querySelector('.startup-text').innerHTML = content;
    }
}

// Button loading states
function setButtonLoading(button, loading = true) {
    if (loading) {
        button.classList.add('btn-loading');
        button.disabled = true;
    } else {
        button.classList.remove('btn-loading');
        button.disabled = false;
    }
}

// Performance optimizations
function debounce(func, wait, immediate = false) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            timeout = null;
            if (!immediate) func.apply(this, args);
        };
        const callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
        if (callNow) func.apply(this, args);
    };
}

// Row pooling for better performance
class RowPool {
    constructor(maxSize = 50) {
        this.pool = [];
        this.maxSize = maxSize;
    }
    
    getRow() {
        return this.pool.pop() || document.createElement('tr');
    }
    
    returnRow(row) {
        if (this.pool.length < this.maxSize) {
            row.innerHTML = '';
            row.className = '';
            row.removeAttribute('data-id');
            this.pool.push(row);
        }
    }
}

const rowPool = new RowPool();

// Global variables and helpers
const $ = id => document.getElementById(id);
const showToast = (msg, type='success') => {
    const container = $('toastContainer');
    const toastElement = document.createElement('div');
    toastElement.className = `toast ${type}`;
    const icons = {success:'check_circle',error:'error',info:'info'};
    toastElement.innerHTML = `<span class="material-icons">${icons[type]}</span>${msg}`;
    container.appendChild(toastElement);
    setTimeout(() => toastElement.remove(), 4500);
};
const formatDate = date => new Date(date).toLocaleString('en-US',{month:'short',day:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit'});
const now = () => new Date().toISOString();

// Application state
let dirHandle, fileHandle, workbook, dataSheet, categorySheet;
let entries = [], categories = [], nextId = 1, editingId = null;
let filteredEntries = [], currentPage = 1;
const FILENAME = 'data.xlsx';
const ENTRIES_PER_PAGE = 20;
let isAutoConnected = false;

// Performance monitoring
let performanceMetrics = {
    renderTime: 0,
    searchTime: 0,
    saveTime: 0,
    totalRenders: 0
};

function updatePerformanceIndicator() {
    const indicator = $('perfIndicator');
    const avgRenderTime = performanceMetrics.renderTime / Math.max(performanceMetrics.totalRenders, 1);
    
    if (avgRenderTime < 30) {
        indicator.innerHTML = '⚡ Excellent';
        indicator.style.background = 'linear-gradient(135deg,#10b981,#059669)';
    } else if (avgRenderTime < 60) {
        indicator.innerHTML = '✨ Good';
        indicator.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
    } else {
        indicator.innerHTML = '🐌 Optimizing...';
        indicator.style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
    }
}

// ✅ FIXED AUTO-DETECTION SYSTEM
async function checkForExistingVault() {
    console.log('🔍 Starting vault auto-detection...');
    
    try {
        // Check browser compatibility first
        if (!window.showDirectoryPicker) {
            console.log('⚠️ File System Access API not supported');
            $('status').textContent = '⚠️ File System Access API not supported. Please use Chrome/Edge browser.';
            showWelcomeMessage();
            return false;
        }
        
        // Update status to show we're checking
        $('status').textContent = '🔍 Checking for existing vault files...';
        
        // Give a short delay to show the status message
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Check if we can access recent directories (this is limited by browser security)
        // For now, we'll show a welcome message and let user select
        console.log('📁 No automatic vault detection available - showing welcome');
        showWelcomeMessage();
        return false;
        
    } catch (error) {
        console.error('Auto-detection error:', error);
        $('status').textContent = '⚠️ Unable to check for existing vaults. Please select folder manually.';
        showWelcomeMessage();
        return false;
    }
}

function showWelcomeMessage() {
    $('status').textContent = '📁 Ready to secure your digital vault. Click "Select Vault Folder" to begin.';
    
    // Show welcome modal
    setTimeout(() => {
        StartupController.show(
            'Welcome to VaultSheet Pro v1.1',
            'Your next-generation password vault is ready! Click the button below to select a folder where your secure vault will be created, or to connect to an existing one.',
            'Select Vault Folder',
            'select'
        );
    }, 500);
}

// Handle startup action button
function handleStartupAction() {
    const button = $('startupBtn');
    const action = button.dataset.action;
    
    switch (action) {
        case 'continue':
            StartupController.hide();
            break;
        case 'select':
        default:
            StartupController.hide();
            // Small delay to let modal close
            setTimeout(() => {
                $('pickFolder').click();
            }, 300);
            break;
    }
}

// Tab navigation
document.querySelectorAll('.tab').forEach(tab => {
    tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        if(tab.dataset.tab === 'categories') openCategoryModal();
    };
});

// Keyboard shortcuts
['username','password','domain','comments'].forEach(id => {
    $(id).addEventListener('keydown', e => {
        if(e.key === 'Enter') $('saveBtn').click();
        if(e.key === 'Escape') $('clearBtn').click();
    });
});

// Debounced search
const debouncedSearch = debounce((query) => {
    const startTime = performance.now();
    applyFilter(query);
    performanceMetrics.searchTime = performance.now() - startTime;
    updatePerformanceIndicator();
}, 200);

$('search').oninput = e => debouncedSearch(e.target.value.toLowerCase());

$('newCategoryInput').addEventListener('keydown', e => {
    if(e.key === 'Enter') addCategory();
});

// Password toggle
$('togglePassword').onclick = () => {
    const input = $('password');
    const icon = $('togglePassword');
    if(input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility_off';
    } else {
        input.type = 'password';
        icon.textContent = 'visibility';
    }
};

// Enhanced folder selection
$('pickFolder').onclick = async () => {
    const button = $('pickFolder');
    
    try {
        if (!window.showDirectoryPicker) {
            showToast('🚫 File System Access API not supported in this browser. Please use Chrome/Edge.', 'error');
            return;
        }
        
        LoadingController.show('🔍 Opening folder selection dialog...', 'default');
        setButtonLoading(button, true);
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        LoadingController.updateText('📂 Waiting for folder selection...');
        dirHandle = await window.showDirectoryPicker({mode: 'readwrite'});
        
        LoadingController.updateText('🔧 Initializing vault structure...');
        
        // Check if this folder already contains a vault
        const hasExistingVault = await checkVaultInFolder(dirHandle);
        if (hasExistingVault) {
            LoadingController.updateText('📊 Found existing vault, loading data...');
        } else {
            LoadingController.updateText('🏗️ Creating new vault structure...');
        }
        
        await initializeWorkbook();
        
        LoadingController.updateText('✅ Vault connected successfully!');
        
        button.disabled = true;
        button.style.opacity = '0.8';
        button.innerHTML = '<span class="material-icons">check_circle</span><span class="btn-text">Folder Connected</span>';
        
        updateStatus();
        $('status').classList.add('status-pulse');
        setTimeout(() => $('status').classList.remove('status-pulse'), 3000);
        
        LoadingController.hide(1000);
        setButtonLoading(button, false);
        showToast(`🎉 Vault ${hasExistingVault ? 'reconnected' : 'created'} successfully!`, 'success');
        
        if (hasExistingVault && entries.length > 0) {
            // Show success modal for existing vault
            setTimeout(() => {
                StartupController.showAutoConnectSuccess(dirHandle.name, entries.length);
            }, 1500);
        }
        
    } catch(error) {
        LoadingController.hide();
        setButtonLoading(button, false);
        
        if (error.name === 'AbortError') {
            showToast('📁 Folder selection cancelled', 'info');
        } else {
            console.error('Folder selection error:', error);
            showToast(`❌ Error: ${error.message}`, 'error');
        }
    }
};

// Check if vault exists in selected folder
async function checkVaultInFolder(folderHandle) {
    try {
        const fileHandle = await folderHandle.getFileHandle(FILENAME, {create: false});
        const file = await fileHandle.getFile();
        return file.size > 0;
    } catch (error) {
        return false;
    }
}

// Enhanced workbook initialization
async function initializeWorkbook() {
    try {
        LoadingController.updateText('📄 Checking for existing vault file...');
        fileHandle = await dirHandle.getFileHandle(FILENAME, {create: true});
        
        let file;
        let isNewVault = false;
        try {
            file = await fileHandle.getFile();
            if (file.size === 0) {
                isNewVault = true;
            }
        } catch (e) {
            file = null;
            isNewVault = true;
        }
        
        LoadingController.updateText('📊 Loading Excel workbook...');
        if(file && file.size > 0) {
            const buffer = await file.arrayBuffer();
            workbook = XLSX.read(buffer, {type: 'array'});
            LoadingController.updateText('📥 Loading existing vault data...');
        } else {
            workbook = XLSX.utils.book_new();
            LoadingController.updateText('🏗️ Creating new vault structure...');
            isNewVault = true;
        }

        LoadingController.updateText('🏗️ Setting up data structure...');
        if(!workbook.SheetNames.includes('Data')) {
            dataSheet = XLSX.utils.aoa_to_sheet([
                ['ID','Username','Password','Domain','Comments','Category','Created','Updated']
            ]);
            XLSX.utils.book_append_sheet(workbook, dataSheet, 'Data');
        } else {
            dataSheet = workbook.Sheets['Data'];
        }

        if(!workbook.SheetNames.includes('category-master')) {
            categorySheet = XLSX.utils.aoa_to_sheet([
                ['Category'],['Personal'],['Work'],['Banking'],['Social'],['Entertainment']
            ]);
            XLSX.utils.book_append_sheet(workbook, categorySheet, 'category-master');
        } else {
            categorySheet = workbook.Sheets['category-master'];
        }

        LoadingController.updateText('📥 Loading existing data...');
        loadData();
        loadCategories();
        
        LoadingController.updateText('🎨 Rendering interface...');
        applyFilter();
        populateCategorySelect();
        renderCategoryList();
        
        if (isNewVault || entries.length === 0) {
            LoadingController.updateText('💾 Saving vault configuration...');
            await autoSave();
        }
        
        if (!isAutoConnected) {
            if (entries.length > 0) {
                showToast(`📊 Loaded existing vault with ${entries.length} entries`, 'info');
            } else {
                showToast('🆕 New vault created and ready to use', 'success');
            }
        }
        
    } catch (error) {
        console.error('Workbook initialization error:', error);
        showToast(`❌ Failed to initialize workbook: ${error.message}`, 'error');
    }
}

// Data loading functions
function loadData() {
    try {
        const data = XLSX.utils.sheet_to_json(dataSheet, {header: 1});
        entries = [];
        nextId = 1;
        
        data.slice(1).forEach(row => {
            if(row[0]) {
                const [id,username,password,domain,comments,category,created,updated] = row;
                entries.push({
                    id: Number(id), username, password, domain, comments, category,
                    created: created || '--',
                    updated: updated || '--'
                });
                nextId = Math.max(nextId, Number(id) + 1);
            }
        });
        
        console.log(`📊 Loaded ${entries.length} entries from vault`);
    } catch (error) {
        console.error('Data loading error:', error);
        entries = [];
        nextId = 1;
    }
}

function loadCategories() {
    try {
        const data = XLSX.utils.sheet_to_json(categorySheet, {header: 1});
        categories = data.slice(1).map(row => row[0]).filter(cat => cat && cat.trim());
        console.log(`📁 Loaded ${categories.length} categories`);
    } catch (error) {
        console.error('Categories loading error:', error);
        categories = ['Personal', 'Work', 'Banking', 'Social', 'Entertainment'];
    }
}

// Filtering & pagination
function applyFilter(searchTerm = '') {
    const query = searchTerm || $('search').value.toLowerCase();
    filteredEntries = entries.filter(entry => 
        JSON.stringify(entry).toLowerCase().includes(query)
    );
    currentPage = 1;
    renderTable();
    renderPagination();
    updatePaginationInfo();
}

// Table rendering functions
function renderTable() {
    const startTime = performance.now();
    const tbody = $('tableBody');
    
    Array.from(tbody.children).forEach(row => {
        rowPool.returnRow(row);
    });
    tbody.innerHTML = '';
    
    const startIndex = (currentPage - 1) * ENTRIES_PER_PAGE;
    const endIndex = startIndex + ENTRIES_PER_PAGE;
    const pageEntries = filteredEntries.slice(startIndex, endIndex);
    
    const fragment = document.createDocumentFragment();
    
    pageEntries.forEach((entry, index) => {
        const row = rowPool.getRow();
        row.dataset.id = entry.id;
        row.style.animationDelay = `${index * 30}ms`;
        row.className = 'table-row-animate';
        
        row.innerHTML = `
          <td class="col-id">${entry.id}</td>
          <td class="col-user" title="${entry.username}">${entry.username}</td>
          <td class="col-pass">
            <div class="password-actions">
              <span class="password-mask" data-password="${entry.password}" title="Click to reveal">${'●'.repeat(Math.min(entry.password.length, 12))}</span>
              <button class="table-btn" data-action="toggle" title="Show/Hide Password">
                <span class="material-icons">visibility</span>
              </button>
              <button class="table-btn success" data-action="copy" title="Copy Password">
                <span class="material-icons">content_copy</span>
              </button>
            </div>
          </td>
          <td class="col-domain" title="${entry.domain}">${entry.domain}</td>
          <td class="col-comments" title="${entry.comments || 'No comments'}">${entry.comments || '--'}</td>
          <td class="col-category">
            <span class="category-badge" title="${entry.category}">${entry.category}</span>
          </td>
          <td class="col-created">
            <div class="timestamp" title="${entry.created !== '--' ? new Date(entry.created).toLocaleString() : 'Not available'}">${entry.created !== '--' ? formatDate(entry.created) : '--'}</div>
          </td>
          <td class="col-updated">
            <div class="timestamp" title="${entry.updated !== '--' ? new Date(entry.updated).toLocaleString() : 'Not available'}">${entry.updated !== '--' ? formatDate(entry.updated) : '--'}</div>
          </td>
          <td class="col-actions">
            <div class="table-actions">
              <button class="table-btn primary" data-action="edit" title="Edit Entry">
                <span class="material-icons">edit</span>
              </button>
              <button class="table-btn danger" data-action="delete" title="Delete Entry">
                <span class="material-icons">delete</span>
              </button>
            </div>
          </td>
        `;
        fragment.appendChild(row);
    });
    
    tbody.appendChild(fragment);
    
    performanceMetrics.renderTime = performance.now() - startTime;
    performanceMetrics.totalRenders++;
    updatePerformanceIndicator();
}

function renderPagination() {
    const totalPages = Math.ceil(filteredEntries.length / ENTRIES_PER_PAGE);
    const pagination = $('pagination');
    pagination.innerHTML = '';
    
    pagination.insertAdjacentHTML('beforeend', `
        <button class="nav-btn" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
          <span class="material-icons">chevron_left</span>
        </button>
      `);
    
    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, currentPage + 2);
    
    if (endPage - startPage < 4) {
        if (startPage === 1) {
            endPage = Math.min(totalPages, startPage + 4);
        } else if (endPage === totalPages) {
            startPage = Math.max(1, endPage - 4);
        }
    }
    
    if(startPage > 1) {
        pagination.insertAdjacentHTML('beforeend', `<button onclick="goToPage(1)">1</button>`);
        if(startPage > 2) {
            pagination.insertAdjacentHTML('beforeend', `<span style="padding:0 8px;color:var(--purple-500);font-weight:600">…</span>`);
        }
    }
    
    for(let i = startPage; i <= endPage; i++) {
        pagination.insertAdjacentHTML('beforeend', `
          <button onclick="goToPage(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>
        `);
    }
    
    if(endPage < totalPages) {
        if(endPage < totalPages - 1) {
            pagination.insertAdjacentHTML('beforeend', `<span style="padding:0 8px;color:var(--purple-500);font-weight:600">…</span>`);
        }
        pagination.insertAdjacentHTML('beforeend', `<button onclick="goToPage(${totalPages})">${totalPages}</button>`);
    }
    
    pagination.insertAdjacentHTML('beforeend', `
        <button class="nav-btn" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''}>
          <span class="material-icons">chevron_right</span>
        </button>
      `);
}

function goToPage(page) {
    const totalPages = Math.ceil(filteredEntries.length / ENTRIES_PER_PAGE);
    if(page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTable();
        renderPagination();
        updatePaginationInfo();
    }
}

function updatePaginationInfo() {
    const startIndex = (currentPage - 1) * ENTRIES_PER_PAGE + 1;
    const endIndex = Math.min(currentPage * ENTRIES_PER_PAGE, filteredEntries.length);
    const total = filteredEntries.length;
    
    $('paginationInfo').textContent = total > 0 
        ? `Showing ${startIndex}-${endIndex} of ${total} entries`
        : 'No entries found';
}

function populateCategorySelect() {
    const select = $('categorySelect');
    select.innerHTML = '<option value="">Choose category...</option>';
    categories.forEach(cat => {
        select.insertAdjacentHTML('beforeend', `<option value="${cat}">${cat}</option>`);
    });
}

function renderCategoryList() {
    const list = $('categoryList');
    list.innerHTML = '';
    categories.forEach(cat => {
        list.insertAdjacentHTML('beforeend', `
          <div class="category-item">
            <span class="category-name">${cat}</span>
            <div class="category-actions">
              <button class="btn btn-secondary" onclick="deleteCategory('${cat}')" style="padding:8px 16px">
                <span class="material-icons">delete</span>
                <span class="btn-text">Remove</span>
              </button>
            </div>
          </div>
        `);
    });
}

function updateStatus() {
    const statusText = isAutoConnected 
        ? `🔐 Auto-Connected: ${dirHandle.name} | ${entries.length} secure entries loaded`
        : `🔐 Vault Active: ${dirHandle.name} | ${entries.length} secure entries stored`;
    $('status').textContent = statusText;
}

// CRUD operations
$('saveBtn').onclick = async () => {
    const startTime = performance.now();
    const button = $('saveBtn');
    
    const username = $('username').value.trim();
    const password = $('password').value;
    const domain = $('domain').value.trim();
    const comments = $('comments').value.trim();
    const category = $('categorySelect').value;

    if(!username || !password || !domain || !category) {
        showToast('⚠️ Please fill all required fields', 'error');
        return;
    }

    try {
        setButtonLoading(button, true);
        
        if(editingId) {
            LoadingController.show('📝 Updating entry...', 'default');
            await updateEntry();
            LoadingController.updateText('✅ Entry updated successfully!');
        } else {
            LoadingController.show('💾 Saving new entry...', 'default');
            await addEntry();
            LoadingController.updateText('✅ Entry added successfully!');
        }
        
        LoadingController.hide(1000);
        
    } catch (error) {
        LoadingController.hide();
        showToast(`❌ Save failed: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
        performanceMetrics.saveTime = performance.now() - startTime;
        updatePerformanceIndicator();
    }
};

async function addEntry() {
    const entry = {
        id: nextId++,
        username: $('username').value.trim(),
        password: $('password').value,
        domain: $('domain').value.trim(),
        comments: $('comments').value.trim(),
        category: $('categorySelect').value,
        created: now(),
        updated: now()
    };
    
    entries.push(entry);
    await saveToExcel();
    applyFilter();
    clearForm();
    updateStatus();
    showToast('✅ Entry added successfully!', 'success');
}

async function updateEntry() {
    const index = entries.findIndex(e => e.id === editingId);
    if(index !== -1) {
        entries[index] = {
            ...entries[index],
            username: $('username').value.trim(),
            password: $('password').value,
            domain: $('domain').value.trim(),
            comments: $('comments').value.trim(),
            category: $('categorySelect').value,
            updated: now()
        };
        
        await saveToExcel();
        applyFilter();
        clearForm();
        updateStatus();
        showToast('📝 Entry updated successfully!', 'info');
    }
}

function editEntry(id) {
    const entry = entries.find(e => e.id === id);
    if(entry) {
        $('username').value = entry.username;
        $('password').value = entry.password;
        $('domain').value = entry.domain;
        $('comments').value = entry.comments;
        $('categorySelect').value = entry.category;
        
        editingId = id;
        $('saveText').textContent = 'Update Entry';
        showToast('✏️ Entry loaded for editing', 'info');
    }
}

async function deleteEntry(id) {
    if(confirm('🗑️ Are you sure you want to permanently delete this entry?')) {
        LoadingController.show('🗑️ Deleting entry...', 'default');
        
        try {
            entries = entries.filter(e => e.id !== id);
            await saveToExcel();
            applyFilter();
            updateStatus();
            
            LoadingController.updateText('✅ Entry deleted successfully!');
            LoadingController.hide(1000);
            showToast('🗑️ Entry deleted successfully', 'info');
        } catch (error) {
            LoadingController.hide();
            showToast(`❌ Delete failed: ${error.message}`, 'error');
        }
    }
}

$('clearBtn').onclick = clearForm;

function clearForm() {
    ['username','password','domain','comments'].forEach(id => $(id).value = '');
    $('categorySelect').value = '';
    editingId = null;
    $('saveText').textContent = 'Save Entry';
}

// Category management
function openCategoryModal() {
    $('categoryModal').style.display = 'flex';
    renderCategoryList();
}

function closeCategoryModal() {
    $('categoryModal').style.display = 'none';
    document.querySelector('.tab[data-tab="vault"]').click();
}

async function addCategory() {
    const newCat = $('newCategoryInput').value.trim();
    const button = document.querySelector('#categoryModal .btn-primary');
    
    if(!newCat) {
        showToast('⚠️ Please enter a category name', 'error');
        return;
    }
    if(categories.includes(newCat)) {
        showToast('⚠️ Category already exists', 'error');
        return;
    }
    
    try {
        setButtonLoading(button, true);
        LoadingController.show('📁 Adding new category...', 'default');
        
        categories.push(newCat);
        await saveCategorySheet();
        populateCategorySelect();
        renderCategoryList();
        $('newCategoryInput').value = '';
        
        LoadingController.updateText('✅ Category added successfully!');
        LoadingController.hide(1000);
        showToast('✅ Category added successfully!', 'success');
        
    } catch (error) {
        LoadingController.hide();
        showToast(`❌ Add category failed: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
}

async function deleteCategory(cat) {
    if(confirm(`🗑️ Delete category "${cat}"? This won't affect existing entries.`)) {
        LoadingController.show('🗑️ Deleting category...', 'default');
        
        try {
            categories = categories.filter(c => c !== cat);
            await saveCategorySheet();
            populateCategorySelect();
            renderCategoryList();
            
            LoadingController.updateText('✅ Category deleted successfully!');
            LoadingController.hide(1000);
            showToast('🗑️ Category deleted successfully', 'info');
        } catch (error) {
            LoadingController.hide();
            showToast(`❌ Delete category failed: ${error.message}`, 'error');
        }
    }
}

// Excel operations
async function saveToExcel() {
    try {
        const dataRows = [['ID','Username','Password','Domain','Comments','Category','Created','Updated']];
        entries.forEach(entry => {
            dataRows.push([entry.id, entry.username, entry.password, entry.domain, entry.comments, entry.category, entry.created, entry.updated]);
        });
        dataSheet = XLSX.utils.aoa_to_sheet(dataRows);
        workbook.Sheets['Data'] = dataSheet;
        
        await autoSave();
    } catch (error) {
        console.error('Save to Excel error:', error);
        showToast(`❌ Failed to save: ${error.message}`, 'error');
    }
}

async function saveCategorySheet() {
    try {
        const catRows = [['Category']];
        categories.forEach(cat => catRows.push([cat]));
        categorySheet = XLSX.utils.aoa_to_sheet(catRows);
        workbook.Sheets['category-master'] = categorySheet;
        
        await autoSave();
    } catch (error) {
        console.error('Save category sheet error:', error);
        showToast(`❌ Failed to save categories: ${error.message}`, 'error');
    }
}

async function autoSave() {
    try {
        if (!fileHandle) {
            throw new Error('No file handle available');
        }
        
        const buffer = XLSX.write(workbook, {bookType: 'xlsx', type: 'array'});
        const writable = await fileHandle.createWritable();
        await writable.write(buffer);
        await writable.close();
    } catch(error) {
        console.error('Auto-save error:', error);
        showToast(`💾 Auto-save failed: ${error.message}`, 'error');
    }
}

$('downloadBtn').onclick = async () => {
    const button = $('downloadBtn');
    
    try {
        setButtonLoading(button, true);
        LoadingController.show('📊 Preparing export...', 'default');
        
        await autoSave();
        
        LoadingController.updateText('✅ Excel vault exported successfully!');
        LoadingController.hide(1000);
        showToast('📊 Excel vault exported successfully!', 'success');
        
    } catch (error) {
        LoadingController.hide();
        showToast(`❌ Export failed: ${error.message}`, 'error');
    } finally {
        setButtonLoading(button, false);
    }
};

// Table interactions
$('tableBody').onclick = async e => {
    const btn = e.target.closest('button');
    if(!btn) return;
    
    const row = btn.closest('tr');
    const id = parseInt(row.dataset.id);
    const action = btn.dataset.action;
    
    switch(action) {
        case 'toggle':
            const mask = row.querySelector('.password-mask');
            const isHidden = mask.textContent.includes('●');
            mask.textContent = isHidden ? mask.dataset.password : '●'.repeat(Math.min(mask.dataset.password.length, 12));
            btn.querySelector('.material-icons').textContent = isHidden ? 'visibility_off' : 'visibility';
            break;
            
        case 'copy':
            const password = row.querySelector('.password-mask').dataset.password;
            try {
                await navigator.clipboard.writeText(password);
                showToast('📋 Password copied to clipboard!', 'success');
            } catch(e) {
                const textArea = document.createElement('textarea');
                textArea.value = password;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('📋 Password copied to clipboard!', 'success');
            }
            break;
            
        case 'edit':
            editEntry(id);
            break;
            
        case 'delete':
            await deleteEntry(id);
            break;
    }
};

// Auto-save on unload
window.addEventListener('beforeunload', async () => {
    if(entries.length) await autoSave();
});

// Close modal when clicking outside
$('categoryModal').onclick = e => {
    if(e.target === $('categoryModal')) closeCategoryModal();
};

// Performance monitoring
setTimeout(() => {
    $('perfIndicator').style.display = 'block';
    updatePerformanceIndicator();
}, 1500);

setTimeout(() => {
    $('perfIndicator').style.display = 'none';
}, 8000);

// ✅ FIXED INITIALIZATION
document.addEventListener('DOMContentLoaded', async function() {
    console.log('🚀 VaultSheet Pro v1.1.1 starting...');
    
    if (!window.showDirectoryPicker) {
        showToast('⚠️ This app requires a modern browser (Chrome/Edge) with File System Access API support', 'error');
        $('status').textContent = '⚠️ Please use Chrome or Edge browser for full functionality.';
        return;
    }
    
    // Initialize the interface first
    applyFilter(); // This will show empty table initially
    populateCategorySelect(); // This will populate with default categories
    
    // Start auto-detection process
    try {
        await checkForExistingVault();
    } catch (error) {
        console.error('Startup error:', error);
        showWelcomeMessage();
    }
    
    console.log('✅ VaultSheet Pro initialization complete');
});
</script>
</body>
</html>
